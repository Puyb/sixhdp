{% extends "base.html" %}
{% load i18n %}
{% load l10n %}
{% load stats %}

{% block main %}
    <div class="clearfix grid_16">
        <canvas id="canvas_time"></canvas>
        <canvas id="canvas_time2"></canvas>
    </div>

    <script src="{{ STATIC_URL }}/js-class.js"></script>
    <script src="{{ STATIC_URL }}/bluff-src.js"></script>

    <script>
        var g = new Bluff.Line('canvas_time', 900);
        g.theme_pastel();
        g.title = '';
        g.tooltips = true;
        g.marker_font_size = 12;
        g.y_axis_increment = 10;
        g.hide_dots = true;
        g.line_width = 2;
        var g2 = new Bluff.Bar('canvas_time2', 900);
        g2.theme_pastel();
        g2.title = '';
        g2.tooltips = true;
        g2.marker_font_size = 12;
        g2.y_axis_increment = 10;

        var stats1 = {{ json1|safe }};
        var stats2 = {{ json2|safe }};

        var min = Math.min(0, {{ delta }});
        var max = Math.max({{ stats1.jours.keys|get_max }}, {{ stats2.jours.keys|get_max }} + {{ delta }});
        var cumul1 = cumul2 = 0;
        console.log(min, max);
        var d1 = [], d2 = [];
        for(var i = min; i < max; i++) {
            var a = b = 0;
            if(i in stats1.jours)
                a = stats1.jours[i].equipes;
            if(i - {{ delta }} in stats2.jours)
                b = stats2.jours[i - {{ delta }}].equipes;
            d1.push(a);
            d2.push(b);
        }
        
        var cumul = 0;
        g.data("{{ course1.uid }}", d1.map(function(value) { return cumul += value; }));
        var cumul = 0;
        g.data("{{ course2.uid }}", d2.map(function(value) { return cumul += value; }));
        g2.data("{{ course1.uid }}", d1);
        g2.data("{{ course2.uid }}", d2);

        g.labels = {};
        for(var i = min; i < max; i += 7) {
            g.labels[i] = i;
            var d1 = new Date({{ course1.date_ouverture.year }}, {{ course1.date_ouverture.month }} - 1, {{ course1.date_ouverture.day }} + i + {{ delta }});
            var d2 = new Date({{ course2.date_ouverture.year }}, {{ course2.date_ouverture.month }} - 1, {{ course2.date_ouverture.day }} + i);
            g.labels[i] = d1.getDate() + '/' + (d1.getMonth() + 1) + '<br />' + d2.getDate() + '/' + (d2.getMonth() + 1);
        }
        g2.labels = g.labels;
        g.draw();
        g._d.stroke = 'white';
        g._d.stroke_width = 1;
        for(var index in g.labels) {
            var x = g._graph_left + (g.x_increment * index);
            g._d.line(x, g._graph_bottom, x, g._graph_top);
        }
        g._d.stroke = g._data[0][2];
        var x = g._graph_left + (g.x_increment * ({{ augment1 }} - {{ delta }}));
        g._d.line(x, g._graph_bottom, x, g._graph_top);
        g._d.stroke = g._data[1][2];
        var x = g._graph_left + (g.x_increment * {{ augment2 }});
        g._d.line(x, g._graph_bottom, x, g._graph_top);

        g2.draw();
        g2._d.stroke = '#ccc';
        g2._d.stroke_width = 1;
        for(var index in g2.labels) {
            var x = g2._graph_left + (g2.x_increment * index);
            g2._d.line(x, g2._graph_bottom, x, g2._graph_top);
        }
        g2._d.stroke = g2._data[0][2];
        var x = g2._graph_left + (g2.x_increment * ({{ augment1 }} - {{ delta }}));
        g2._d.line(x, g2._graph_bottom, x, g2._graph_top);
        g2._d.stroke = g2._data[1][2];
        var x = g2._graph_left + (g2.x_increment * {{ augment2 }});
        g2._d.line(x, g2._graph_bottom, x, g2._graph_top);


        var e = document.getElementById('canvas_time').parentNode;
        var e2 = document.getElementById('canvas_time2').parentNode;
        e2.style.display = 'none';
        e.addEventListener('click', function() { e.style.display = 'none', e2.style.display = 'block'; });
        e2.addEventListener('click', function() { e2.style.display = 'none', e.style.display = 'block'; });
    </script>
{% endblock %}
